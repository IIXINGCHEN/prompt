# 开发指南 (v2.0)

## 开发哲学

### 核心信条

- **增量优于大爆炸** - 小步快跑，持续集成。
- **借鉴优于独创** - 在实现前先研究和学习现有代码。
- **务实优于教条** - 适应项目现实，不拘泥于形式。
- **意图清晰优于代码巧妙** - 让代码不言自明，简单直白。

### 简洁之道

- **单一职责**：每个函数/类只做一件事。
- **避免过早抽象**：在必要时才进行抽象。
- **拒绝奇技淫**：选择简单质朴的方案。
- **无需解释**：如果一段代码需要注释才能看懂，那它就太复杂了。

***

## 开发流程

### 1. 阶段性规划 (Staging Plan)

将复杂工作分解为3-5个可验证的阶段，记录在 `IMPLEMENTATION_PLAN.md` 文件中，**或关联到对应的项目管理工具卡片（如Jira, GitHub Issue）**。

```markdown
## 阶段 N：[阶段名称]
**目标**：[明确的可交付成果]
**验收标准**：[可被测试验证的结果]
**关键测试点**：[需要覆盖的核心测试用例]
**状态**：[未开始 | 进行中 | 已完成]
````

  - 随时更新计划状态。
  - 所有阶段完成后删除此文件或关闭卡片。

### 2\. 实现流程 (红-绿-重构)

1.  **理解** - 深入研究代码库中的既有模式。
2.  **测试先行** - 先编写失败的测试（**红灯**）。
3.  **快速实现** - 用最少的代码让测试通过（**绿灯**）。
4.  **优雅重构** - 在测试持续通过的前提下，优化代码结构。
5.  **清晰提交** - 提交信息需清晰，并关联到开发计划。

### 3\. 脱困策略 (三振出局法)

**核心原则**：针对同一问题，主动尝试不超过**3**次。如果仍然卡住，必须**停下**并转换思路。

1.  **复盘失败**：记录尝试的方法、错误信息和失败原因。
2.  **寻找替代方案**：研究2-3个类似的参考实现。
3.  **回归本源**：反思抽象层级、问题拆分和基础方法。
4.  **切换攻击角度**：尝试不同的库、模式或思路。
5.  **主动求助 (Ask for Help)**：
      - 在清晰地记录了以上步骤后，主动向同事或技术负责人求助。
      - 准备好问题的简要描述和你已尝试过的方案总结。
      - 可以发起一个简短的结对编程 (Pair Programming) 会话来共同解决。

### 4\. 代码审查流程 (Pull Request)

所有非紧急修复的代码变更都必须通过 Pull Request (PR) 或 Merge Request (MR) 合并。

**作者 (Author) 指南:**

  - PR 标题应清晰，遵循 `类型(范围): 简短描述` 的格式 (如 `feat(api): add user profile endpoint`)。
  - PR 描述中必须链接到对应的任务卡片或 `IMPLEMENTATION_PLAN.md`。
  - 在提交审查前，进行自我审查，确保遵循了本指南的所有规范。
  - 邀请至少一位相关同事作为审查者 (Reviewer)。

**审查者 (Reviewer) 指南:**

  - **优先理解意图**：变更的目的是什么？是否优雅地解决了问题？
  - **关注核心逻辑**：设计是否合理？是否存在潜在的 bug 或性能问题？
  - **代码可读性**：命名是否清晰？逻辑是否易于理解？
  - **测试覆盖率**：测试是否充分、有效？
  - **提出建设性意见**：使用提问和建议的语气（例如“这里用策略模式会不会更灵活？”），避免命令。

**合并标准:**

  - [ ] CI/CD 流程全部通过。
  - [ ] 获得至少一位审查者的批准 (Approve)。
  - [ ] 所有审查意见都已被解决或作为后续任务记录。

-----

## 技术标准

### 架构原则

  - **组合优于继承** - 优先使用依赖注入。
  - **接口优于实现** - 面向接口编程，方便测试与扩展。
  - **显式优于隐式** - 保持清晰的数据流和依赖关系。
  - **修复测试优于禁用** - 绝不跳过或禁用失败的测试。

### 代码质量

  - **每次提交必须**：

      - 成功编译。
      - 通过所有相关测试。

    <!-- end list -->

      * 为新功能提供单元测试。

    <!-- end list -->

      - 符合代码风格和静态检查规范。

  - **提交前检查**：

      - 运行格式化与静态检查工具。
      - 自我 Code Review。
      - 确保提交信息解释清楚“为什么”这样修改。

### 异常处理

  - **快速失败**，并提供有意义的错误信息。
  - **包含上下文**，方便快速定位问题（如 `TraceID`, `UserID`）。
  - **分层处理**，在最合适的层级捕获和处理异常。
  - **严禁“吞掉”异常**，不能对异常静默处理。

### 日志规范 (Logging)

  - **使用日志级别**：明确 `INFO`, `WARN`, `ERROR`, `DEBUG` 的使用场景。`INFO` 用于记录关键业务流程，`WARN` 用于记录可恢复的异常或未来可能导致问题的情况，`ERROR` 用于记录必须立即关注的错误。
  - **采用结构化日志**：推荐使用 JSON 格式，方便机器解析和查询。
  - **包含关键上下文**：每条日志都应包含 `TraceID`，并尽可能包含业务上下文信息（如 `OrderID`, `UserID`）。
  - **禁止记录敏感信息**：严禁在日志中记录任何形式的密码、密钥、个人身份信息（PII）等敏感数据。

-----

## 决策框架

当存在多种有效方案时，按以下优先级进行决策：

1.  **可测试性** - 这个方案容易编写自动化测试吗？
2.  **可读性/可维护性** - 半年后，其他人能轻松理解和修改吗？
3.  **一致性** - 这个方案是否遵循了项目现有的设计模式？
4.  **简洁性** - 这是能解决问题的最简单的方案吗？
5.  **可逆性** - 如果未来证明这个决策是错的，撤销它的成本有多高？

### 引入新依赖决策

在决定引入一个新的第三方库或框架前，必须评估以下几点：

1.  **必要性**：是否确实需要？能否用现有技术栈以合理成本解决？
2.  **维护性**：该依赖的社区是否活跃？最近一次更新是什么时候？Issue 是否有专人维护？
3.  **安全性**：使用 `snyk` 等工具检查是否存在已知的安全漏洞。
4.  **体积与性能**：它会显著增加最终构建产物的体积或对运行时性能造成影响吗？
5.  **一致性**：它的设计哲学是否与我们现有的技术栈和架构风格匹配？

-----

## 融入项目

### 熟悉代码库

  - 找到3个与当前任务相似的功能或组件。
  - 识别并遵循其中通用的设计模式和代码约定。
  - 尽可能复用项目中已有的库和工具函数。
  - 遵循项目中已有的测试风格和模式。

### 工具链

  - 使用项目既有的构建系统。
  - 使用项目既有的测试框架。
  - 使用项目既有的代码风格和静态检查配置。
  - 在没有充分论证前，不引入新的开发工具。

-----

## 质量门 (Quality Gates)

### “完成”的定义 (Definition of Done)

  - [ ] 单元测试和集成测试已编写并通过。
  - [ ] 代码遵循项目的规范和约定。
  - [ ] 没有静态检查或格式化工具的警告。
  - [ ] 提交信息清晰、规范。
  - [ ] 最终实现与设计计划一致。
  - [ ] 代码中没有不关联任务ID的`TODO`。

### 测试准则

  - **测试行为，而非实现细节**。
  - **一个测试只验证一个场景**。
  - **测试命名要清晰**，能描述出测试的场景和预期结果。
  - **复用**项目中已有的测试辅助工具和函数。
  - **测试必须是确定性的**，杜绝不稳定的（Flaky）测试。

#### 单元测试 (Unit Tests)

  - **快**：运行速度必须非常快。
  - **隔离**：不依赖外部服务（如文件系统、网络、数据库），使用 Mocks 或 Stubs 进行隔离。

#### 集成测试 (Integration Tests)

  - **验证交互**：专注于测试模块或服务之间的接口和交互是否正确。
  - **依赖受控环境**：可以依赖受控的外部环境（如内存数据库、测试消息队列）。

#### 端到端测试 (E2E Tests)

  - **覆盖关键流程**：只为最核心的用户业务流程编写 E2E 测试。
  - **少而精**：数量要严格控制，因为其运行和维护成本最高。

-----

## 重要提醒

### 行为红线 (NEVER)

  - **绝不**使用 `--no-verify` 等参数绕过代码质量检查。
  - **绝不**为了省事而禁用或注释掉失败的测试。
  - **绝不**提交无法编译或无法运行的代码。
  - **绝不**凭空猜测，必须通过分析现有代码来验证假设。

### 黄金法则 (ALWAYS)

  - **始终**以小步、可工作的方式增量提交代码。
  - **始终**在开发过程中同步更新你的计划文档。
  - **始终**从项目中已有的优秀实现中学习。
  - **始终**在连续3次尝试失败后停下，并启动脱困策略。

<!-- end list -->

```
```
